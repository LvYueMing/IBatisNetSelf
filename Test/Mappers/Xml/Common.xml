<?xml version="1.0" encoding="utf-8" ?>
<sqlMap namespace="Common" xmlns="http://ibatis.apache.org/mapping" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" >

	<parameterMaps>
		<parameterMap class="Hashtable" id="PM.HSEMR.PCK_MR_CIRCULATION.S_流转_流程接收">
			<parameter column="IN_MR_FILE_ID" direction="Input" property="inMrFileId"/>
			<parameter column="IN_HOSP_ID" direction="Input" property="inHospId"/>
			<parameter column="IN_DEPT_ID" direction="Input" property="inDeptId"/>
			<parameter column="IN_WORKER_ID" direction="Input" property="inWorkerId"/>
		</parameterMap>

		<parameterMap class="Hashtable" id="PM.HSEMR.PCK_MR_CIRCULATION.S_流转_流程提交">
			<parameter column="IN_MR_FILE_ID" direction="Input" property="inMrFileId"/>
			<parameter column="IN_CHECK_STEP" direction="Input" property="inCheckStep"/>
			<parameter column="IN_HOSP_ID" direction="Input" property="inHospId"/>
			<parameter column="IN_DEPT_ID" direction="Input" property="inDeptId"/>
			<parameter column="IN_WORKER_ID" direction="Input" property="inWorkerId"/>
		</parameterMap>
	</parameterMaps>

	<statements>

		<select id="Order_GetOrderList" parameterClass="Hashtable" resultClass="ResultMap.OrderList,ResultMap">
      select a.id,
             decode(a.parentid,
                    a.id,
                    substr(hospital.get_field_dict_name('ORDER_LIST',
                                                        'TYPE',
                                                        a.type),
                           1,
                           4),
                    null,
                    substr(hospital.get_field_dict_name('ORDER_LIST',
                                                        'TYPE',
                                                        a.type),
                           1,
                           4),
                    null) type,
             decode(a.parentid,
                    a.id,
                    substr(hospital.get_field_dict_name('ORDER_LIST',
                                                        'LONG_FLAG',
                                                        a.long_flag),
                           1,
                           2) || decode(a.cir_drug_flag, '1', '[带]', null) ||
                    decode(a.self_drug, '1', '[备]', null),
                    null,
                    substr(hospital.get_field_dict_name('ORDER_LIST',
                                                        'LONG_FL AG',
                                                        a.long_flag),
                           1,
                           2) || decode(a.cir_drug_flag, '1', '[带]', null) ||
                    decode(a.self_drug, '1', '[备]', null),
                    null) flag,
             decode(a.parentid,
                    a.id,
                    decode(a.status,
                           'WAIT_AUDIT',
                           '待审核',
                           substr(hospital.get_field_dict_name('ORDER_LIST',
                                                               'STATUS',
                                                               a.status),
                                  1,
                                  4)),
                    null,
                    decode(a.status,
                           'WAIT_AUDIT',
                           '待审核',
                           substr(hospital.get_field_dict_name('ORDER_LIST',
                                                               'STATUS',
                                                               a.status),
                                  1,
                                  4)),
                    null) orderstatus,
             decode(a.parentid,
                    a.id,
                    substr(hospital.get_field_dict_name('ORDER_LIST',
                                                        'STATUS1',
                                                        a.status1),
                           1,
                           4),
                    null,
                    substr(hospital.get_field_dict_name('ORDER_LIST',
                                                        'STATUS1',
                                                        a.status1),
                           1,
                           4),
                    null) executestatus,
             decode(a.parentid,
                    a.id,
                    hospital.exam_apply.get_检查申请单_状态(a.id),
                    null,
                    hospital.exam_apply.get_检查申请单_状态(a.id),
                    null) applystatus,
             decode(a.parentid,
                    a.id,
                    hospital.exam_apply.get_检查申请单_id(a.id),
                    null,
                    hospital.exam_apply.get_检查申请单_id(a.id),
                    null) applyno,
             decode(a.parentid,
                    a.id,
                    to_char(a.start_date, 'MM-DD HH24:MI'),
                    null,
                    to_char(a.start_date, 'MM-DD HH24:MI'),
                    null) startshortdate,
             decode(a.input_way, 'KYYZ', '(会诊)', null) ||
             trim(hospital.get_医嘱医保信息(a.sundry_feeid, a.materialid, #in_hospid#) ||
                  nvl(a.order_content,
                      hospital.get_sundry_fee_name(a.sundry_feeid) ||
                      hospital.get_material_name(a.materialid) || a.text)) || ' ' ||
             a.method ||
             decode(a.check_point, null, ' ', ' [' || a.check_point || ']') ||
             decode(a.comment_text,
                    null,
                    ' ',
                    ' <![CDATA[<]]>' || a.comment_text || '<![CDATA[>]]> ') ||
             hospital.get_field_dict_name('ORDER_LIST',
                                          'SKIN_TEST_RESULT',
                                          a.skin_test_result) || a.drop_speed ||
             a.drop_speed_unit ordercontent,
             decode(a.skin_test_sign1,
                    null,
                    decode(a.parentid,
                           a.id,
                           hospital.get_order_list_audit(a.id),
                           null),
                    a.skin_test_sign1 || '于' ||
                    to_char(a.skin_test_sign1_date, 'YYYY-MM-DD HH24:MI:SS') ||
                    '皮试，皮试结果为' || decode(a.skin_test_result1,
                                         '1',
                                         '阴性',
                                         '2',
                                         '阳性',
                                         '3',
                                         '弱阳性',
                                         '4',
                                         '强阳性') ||
                    decode(hospital.get_system_option('医嘱皮试_启用皮试复核'),
                           'Y',
                           decode(a.skin_test_sign2,
                                  null,
                                  '，还未皮试复核！',
                                  '。' || a.skin_test_sign2 || '于' ||
                                  to_char(a.skin_test_sign2_date,
                                          'YYYY-MM-DD HH24:MI:SS') || '复核皮试，复核结果为' ||
                                  decode(a.skin_test_result2,
                                         '1',
                                         '阴性',
                                         '2',
                                         '阳性',
                                         '3',
                                         '弱阳性',
                                         '4',
                                         '强阳性') || '。'),
                           '! ')) || decode(a.parentid,
                                            a.id,
                                            hospital.get_remote_treament_order(a.id),
                                            null) ||
             hospital.get_cross_hosp_order(a.id) skintestinfo,
             hospital.get_package_description(a.packageid) packagedescription,
             hospital.get_package_description_ex(a.packageid) specification,
             hospital.get_package_medicament(a.packageid) dosageform,
             a.amount amount,
             nvl(hospital.get_sundry_fee_unit(a.sundry_feeid),
                 hospital.get_package_name(a.packageid)) unit,
             substr(decode(substr(to_char(a.amount) ||
                                  nvl(hospital.get_sundry_fee_unit(a.sundry_feeid),
                                      hospital.get_package_name(a.packageid)),
                                  1,
                                  1),
                           '.',
                           '0' || to_char(a.amount) ||
                           nvl(hospital.get_sundry_fee_unit(a.sundry_feeid),
                               hospital.get_package_name(a.packageid)),
                           to_char(a.amount) ||
                           nvl(hospital.get_sundry_fee_unit(a.sundry_feeid),
                               hospital.get_package_name(a.packageid))),
                    1,
                    6) dailydosage,
             decode(a.parentid,
                    a.id,
                    to_char(a.this_days, 'FM999'),
                    null,
                    to_char(a.this_days, 'FM999'),
                    null) thisdays,
             decode(a.parentid,
                    a.id,
                    to_char(a.start_date + a.executed_days, 'YYYY-MM-DD'),
                    null,
                    null,
                    to_char(a.start_date + a.executed_days, 'YYYY-MM-DD')) executeddate,
             round(a.price, 3) price,
             decode(a.parentid,
                    a.id,
                    substr(hospital.get_worker_name(a.input_workerid), 1, 5),
                    null,
                    substr(hospital.get_worker_name(a.input_workerid), 1, 5),
                    null) inputworker,
             decode(a.parentid,
                    a.id,
                    to_char(a.input_date, 'YYYY-MM-DD HH24:MI:SS'),
                    null,
                    to_char(a.input_date, 'YYYY-MM-DD HH24:MI:SS'),
                    null) inputdate,
             decode(a.parentid,
                    a.id,
                    to_char(a.account_date, 'YYYY-MM-DD HH24:MI:SS'),
                    null,
                    to_char(a.account_date, 'YYYY-MM-DD HH24:MI:SS'),
                    null) accountdate,
             decode(a.parentid,
                    a.id,
                    to_char(a.execute_date, 'YYYY-MM-DD HH24:MI:SS'),
                    null,
                    to_char(a.execute_date, 'YYYY-MM-DD HH24:MI:SS'),
                    null) executedate,
             decode(a.material_deptid,
                    null,
                    hospital.get_dept_name(a.execute_deptid),
                    hospital.get_dept_name(a.material_deptid)) medicinedept,
             a.sequence,
             a.long_flag,
             to_char(a.start_date, 'YYYY-MM-DD HH24:MI:SS') start_date,
             a.input_date,
             a.parentid,
             a.type typeflag,
             a.start_workerid,
             a.comment_text,
             a.status,
             a.subseq,
             hospital.get_药品抗菌药物级别(a.materialid) attr,
             hospital.get_医生用药权限(a.start_workerid, a.materialid) can_use,
             case
               when a.materialid is not null then
                '药品类型'
               when a.sundry_feeid is not null then
                '杂费类型'
               when a.text is not null then
                '文本类型'
               else
                ''
             end 医嘱类型,
             a.light_flag,
             a.materialid,
             a.sundry_feeid,
             a.text,
             hospital.get_医嘱医保信息(null, a.materialid, #in_hospid#) ||
             hospital.get_material_name(a.materialid) material_name,
             to_char(a.stop_date, 'YYYY-MM-DD HH24:MI:SS') stopdate,
             substr(hospital.get_worker_name(a.stop_workerid), 1, 5) stopworker,
             a.method,
             a.materialid || a.packageid pass_materialid,
             round(a.amount * a.price, 3) subtotal,
             a.skin_test_result1,
             a.skin_test_sign1_workerid skintester1,
             a.skin_test_sign2_workerid skintester2,
             a.material_deptid,
             a.packageid,
             a.skin_test_result skintestresult,
             a.first_executions firstexecutions,
             a.last_executions lastexecutions,
             a.first_executions || '/' || a.last_executions firstlastexecutions,
             a.first_exec_amount,
             a.last_exec_amount,
             to_char(a.medicament, 'FM9999990.000') || a.medicament_unit dosage,
             hospital.get_sundry_fee_name(a.sundry_feeid) sundry_fee_name,
             hospital.get_material_name(a.materialid) drugname,
             substr(hospital.get_field_dict_name('SUNDRY_FEE',
                                                 'SAMPLE_TYPE',
                                                 a.sample_type),
                    1,
                    12) sample_type,
             hospital.get_ol_combo_flag(a.id) comboflag,
             hospital.get_sundry_fee_pre_type(a.sundry_feeid, #in_hospid#) prescriptiontype,
             hospital.get_material_name(a.materialid) ||
             hospital.get_sundry_fee_name(a.sundry_feeid) || a.text order_name,
             '0' expand,
             hospital.get_ol_record_ca(a.id) signature,
             hospital.get_his_material_collateid(#in_hospid#,
                                                 a.materialid,
                                                 a.packageid,
                                                 a.purchaseid,
                                                 a.sundry_feeid) nationalinsurancecode,
             hospital.get_his_material_collate_name(#in_hospid#,
                                                    a.materialid,
                                                    a.packageid,
                                                    a.purchaseid,
                                                    a.sundry_feeid) nationalinsurancename,
             hospital.get_field_dict_name('ORDER_LIST',
                                          'INSPECT_ITEM',
                                          a.inspect_item) inspectitem,
             hospital.get_ol_mr_file_id(a.id) mr_file_id,
             hsemr.get_mr_doc_class_ex(hospital.get_ol_mr_file_id(a.id)) mr_doc_class,
             decode(a.parentid,
                    a.id,
                    to_char(a.start_date, 'YYYY-MM-DD HH24:MI'),
                    null,
                    to_char(a.start_date, 'YYYY-MM-DD HH24:MI'),
                    null) starttime,
             a.input_way,
             hospital.get_field_dict_name('PRESCRIPTION_DETAIL',
                                          'CYCLE_MARKER',
                                          a.cycle_marker) cycle_marker,
             decode(a.parentid,
                    a.id,
                    to_char(a.ack_date, 'MM-DD HH24:MI'),
                    null,
                    to_char(a.ack_date, 'MM-DD HH24:MI'),
                    null) ackdate,
             hospital.get_worker_name(a.execute_workerid) executor,
             a.frequence_dict,
             hospital.get_order_crosss_hosp_url(a.id) url,
             to_char(a.planned_stop_date, 'YYYY-MM-DD HH24:MI:SS') planned_stop_date,
             case
               when to_number(to_char(a.planned_stop_date, 'hh24')) >= '8'
                    or a.last_executions is not null then
                (a.skip_days + a.executed_days) || '/' ||
                (trunc(a.planned_stop_date) - trunc(a.start_date) + 1)
               else
                (a.skip_days + a.executed_days) || '/' ||
                (trunc(a.planned_stop_date) - trunc(a.start_date))
             end executeddaysinfo,
             hospital.get_field_dict_name('ORDER_LIST',
                                          'USE_REASON',
                                          a.use_reason) usereason
        from hospital.order_list a
       where a.ownerid = #in_ownerid#
			    and a.long_flag in ('A', 'B')
					and (a.status in ('WAIT_ACK', 'NORMAL', 'WAIT_AUDIT', 'WAIT_CHECK') or
             a.status = 'STOPPED' and a.status1 = 'WAIT_ACK')  
       order by long_flag, sequence, subseq, input_date
		</select>
		
		<procedure id="HSEMR.PCK_MR_CIRCULATION.S_流转_流程接收" parameterMap="PM.HSEMR.PCK_MR_CIRCULATION.S_流转_流程接收">
			HSEMR.PCK_MR_CIRCULATION.S_流转_流程接收
		</procedure>

		<procedure id="HSEMR.PCK_MR_CIRCULATION.S_流转_流程提交" parameterMap="PM.HSEMR.PCK_MR_CIRCULATION.S_流转_流程提交">
			HSEMR.PCK_MR_CIRCULATION.S_流转_流程提交
		</procedure>

	</statements>
</sqlMap>